name: Update IP List From GeoIP

on:
  workflow_dispatch:
  schedule:
    - cron: "0 2 * * *"  # æ¯å¤© UTC æ—¶é—´ 2 ç‚¹è¿è¡Œ

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # éœ€è¦å†™å…¥æƒé™æ¥æ¨é€æ›´æ”¹

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0  # è·å–å®Œæ•´å†å²è®°å½•

      - name: Download MetaCubeX rules
        run: |
          echo "ğŸ“¥ Downloading MetaCubeX GeoIP rules..."
          curl -L \
            https://github.com/MetaCubeX/meta-rules-dat/archive/refs/heads/meta.tar.gz \
            -o meta.tar.gz
          tar -xzf meta.tar.gz
          
          echo "ğŸ“ Checking downloaded structure..."
          if [ -d "meta-rules-dat-meta/geo/geoip" ]; then
            echo "âœ… GeoIP directory found"
            echo "Available GeoIP files:"
            ls meta-rules-dat-meta/geo/geoip/*.list | head -10
          else
            echo "âŒ GeoIP directory not found!"
            find meta-rules-dat-meta -type d -name "*geo*" | sort
            exit 1
          fi

      - name: Generate selected Shadowrocket IP rules
        run: |
          set -e

          echo "ğŸ“‚ Creating directory structure..."
          mkdir -p shadowrocket/ip
          
          SOURCE_DIR="meta-rules-dat-meta/geo/geoip"
          echo "Source directory: $SOURCE_DIR"
          
          # æ£€æŸ¥æºç›®å½•æ˜¯å¦å­˜åœ¨
          if [ ! -d "$SOURCE_DIR" ]; then
            echo "âŒ Error: GeoIP source directory not found!"
            exit 1
          fi

          # æ£€æŸ¥ lists.txt æ–‡ä»¶
          if [ ! -f "lists.txt" ]; then
            echo "âŒ Error: lists.txt file not found!"
            echo "Current directory contents:"
            ls -la
            exit 1
          fi

          echo "ğŸ“‹ Processing lists.txt..."
          total_count=0
          success_count=0
          
          # å¤åˆ¶ lists.txt ç”¨äºå¤„ç†
          cp lists.txt lists_ip.txt
          
          while IFS= read -r name || [ -n "$name" ]; do
            # è·³è¿‡ç©ºè¡Œ
            if [ -z "$name" ]; then
              continue
            fi
            
            # è·³è¿‡æ³¨é‡Šè¡Œ
            if [[ "$name" =~ ^[[:space:]]*# ]]; then
              continue
            fi
            
            # æ¸…ç†å¯èƒ½çš„ç©ºç™½å­—ç¬¦
            name=$(echo "$name" | xargs)
            
            total_count=$((total_count + 1))
            
            src="$SOURCE_DIR/$name.list"
            dst="shadowrocket/ip/$name.list"

            if [ ! -f "$src" ]; then
              echo "âš ï¸  Skip missing GeoIP list: $name.list"
              # æ˜¾ç¤ºå¯ç”¨çš„æ–‡ä»¶ä»¥å¸®åŠ©è°ƒè¯•
              if [ $total_count -eq 1 ]; then
                echo "   Available GeoIP files:"
                ls "$SOURCE_DIR"/*.list | head -10
              fi
              continue
            fi

            # å¤„ç†æ–‡ä»¶ - ä¿®æ”¹è¿™é‡Œä»¥æ·»åŠ  ,no-resolve
            echo "ğŸ”„ Processing: $name"
            
            # æ–¹æ³•1: ä½¿ç”¨ sed æ·»åŠ  ,no-resolve
            # å…ˆåˆ é™¤å¼€å¤´çš„ +. å¦‚æœæœ‰çš„è¯ï¼Œç„¶åæ·»åŠ  IP-CIDR, å’Œ ,no-resolve
            sed -e 's/^+\.//g' -e 's/^/IP-CIDR,/' -e 's/$/,no-resolve/' "$src" > "$dst"
            
            # æˆ–è€…æ–¹æ³•2: ä½¿ç”¨ awkï¼ˆå¤‡ç”¨æ–¹æ³•ï¼‰
            # awk '{gsub(/^\+\./, ""); print "IP-CIDR," $0 ",no-resolve"}' "$src" > "$dst"
            
            # éªŒè¯ç”Ÿæˆçš„æ ¼å¼
            echo "   Sample output (first 3 lines):"
            head -3 "$dst"
            
            success_count=$((success_count + 1))
            echo "âœ… Generated: $dst (lines: $(wc -l < "$dst"))"
          done < "lists_ip.txt"

          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          rm -f lists_ip.txt

          echo "=========================================="
          echo "ğŸ“Š Processing completed!"
          echo "Total entries processed: $total_count"
          echo "Successfully generated: $success_count"
          
          if [ $success_count -eq 0 ]; then
            echo "âŒ Error: No IP files were generated!"
            echo "Please check:"
            echo "1. lists.txt contains correct GeoIP list names"
            echo "2. The source directory has the expected files"
            exit 1
          fi
          echo "=========================================="

      - name: Verify generated IP files
        run: |
          echo "ğŸ” Verifying generated IP files..."
          if [ ! -d "shadowrocket/ip" ]; then
            echo "âŒ Error: shadowrocket/ip directory not found!"
            exit 1
          fi
          
          echo "ğŸ“ Generated files in shadowrocket/ip/:"
          ls -la shadowrocket/ip/*.list 2>/dev/null || {
            echo "âŒ No .list files found in shadowrocket/ip/"
            exit 1
          }
          
          echo "ğŸ“Š File count: $(ls shadowrocket/ip/*.list 2>/dev/null | wc -l)"
          
          # æ£€æŸ¥æ–‡ä»¶æ ¼å¼
          echo "âœ… Checking file format..."
          sample_file=$(find shadowrocket/ip -name "*.list" | head -1)
          if [ -f "$sample_file" ]; then
            echo "Sample format check for: $(basename "$sample_file")"
            echo "First line: $(head -1 "$sample_file")"
            echo "Last line: $(tail -1 "$sample_file")"
            
            # éªŒè¯æ ¼å¼æ˜¯å¦æ­£ç¡®
            if head -1 "$sample_file" | grep -q "^IP-CIDR,.*,no-resolve$"; then
              echo "âœ… Format verification passed: IP-CIDR,xxx.xxx.xxx.xxx/xx,no-resolve"
            else
              echo "âŒ Format verification failed!"
              echo "Expected: IP-CIDR,xxx.xxx.xxx.xxx/xx,no-resolve"
              echo "Got: $(head -1 "$sample_file")"
              exit 1
            fi
          fi

      - name: Commit and push changes
        run: |
          # è®¾ç½® Git ç”¨æˆ·ä¿¡æ¯
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          echo "ğŸ”„ Pulling latest changes from remote..."
          # æ‹‰å–è¿œç¨‹æ›´æ”¹ï¼Œä½¿ç”¨ --rebase é¿å…å†²çª
          git pull origin main --rebase --autostash || {
            echo "âš ï¸  Pull with rebase failed, trying merge strategy..."
            git fetch origin
            git merge origin/main --no-edit || {
              echo "âŒ Merge failed, aborting..."
              git merge --abort
              exit 1
            }
          }
          
          echo "ğŸ“ Staging IP rule files..."
          # æ·»åŠ ç”Ÿæˆçš„æ–‡ä»¶
          if ! ls shadowrocket/ip/*.list 1>/dev/null 2>&1; then
            echo "âŒ No IP list files found to add!"
            exit 1
          fi
          
          git add shadowrocket/ip/*.list
          
          # æ£€æŸ¥æ˜¯å¦æœ‰ staged çš„æ›´æ”¹
          if git diff --cached --quiet; then
            echo "â„¹ï¸  No changes to commit (files are identical)"
            exit 0
          fi
          
          echo "ğŸ’¾ Creating commit..."
          # åˆ›å»ºæäº¤
          commit_message="Update GeoIP lists - $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          git commit -m "$commit_message"
          
          echo "ğŸš€ Pushing changes to remote..."
          # æ¨é€æ›´æ”¹ï¼Œæœ€å¤šé‡è¯•3æ¬¡
          max_retries=3
          retry_count=0
          
          while [ $retry_count -lt $max_retries ]; do
            if git push origin main; then
              echo "âœ… Successfully pushed GeoIP changes!"
              break
            else
              retry_count=$((retry_count + 1))
              echo "âš ï¸  Push failed (attempt $retry_count/$max_retries)"
              
              if [ $retry_count -eq $max_retries ]; then
                echo "âŒ Failed to push after $max_retries attempts"
                echo "Last error output above."
                exit 1
              fi
              
              echo "ğŸ”„ Pulling latest changes and retrying..."
              sleep 2
              git pull origin main --rebase --autostash
            fi
          done

      - name: Workflow summary
        run: |
          echo "ğŸ‰ GeoIP Workflow completed successfully!"
          echo "=========================================="
          echo "Summary:"
          echo "- Generated files: shadowrocket/ip/*.list"
          echo "- Format: IP-CIDR,xxx.xxx.xxx.xxx/xx,no-resolve"
          echo "- Commit: $(git log -1 --oneline)"
          echo "=========================================="
          echo "You can view the changes at:"
          echo "https://github.com/${{ github.repository }}/tree/main/shadowrocket/ip"
