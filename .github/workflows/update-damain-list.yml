name: Update Domain List From Geo

on:
  workflow_dispatch:
  schedule:
    - cron: "0 2 * * *"  # æ¯å¤© UTC æ—¶é—´ 2 ç‚¹è¿è¡Œ

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # éœ€è¦å†™å…¥æƒé™æ¥æ¨é€æ›´æ”¹

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0  # è·å–å®Œæ•´å†å²è®°å½•

      - name: Download MetaCubeX rules
        run: |
          echo "Downloading MetaCubeX rules..."
          curl -L \
            https://github.com/MetaCubeX/meta-rules-dat/archive/refs/heads/meta.tar.gz \
            -o meta.tar.gz
          tar -xzf meta.tar.gz
          echo "Download completed."

      - name: Generate selected Shadowrocket rules
        run: |
          set -e

          echo "Creating directory structure..."
          mkdir -p shadowrocket/domain
          
          SOURCE_DIR="meta-rules-dat-meta/geo/geosite"
          echo "Source directory: $SOURCE_DIR"
          
          # æ£€æŸ¥æºç›®å½•æ˜¯å¦å­˜åœ¨
          if [ ! -d "$SOURCE_DIR" ]; then
            echo "Error: Source directory not found!"
            echo "Available directories:"
            find meta-rules-dat-meta -type d | head -20
            exit 1
          fi

          # æ£€æŸ¥ lists.txt æ–‡ä»¶
          if [ ! -f "lists.txt" ]; then
            echo "Error: lists.txt file not found!"
            ls -la
            exit 1
          fi

          echo "Processing lists.txt..."
          total_count=0
          success_count=0
          
          while IFS= read -r name || [ -n "$name" ]; do
            # è·³è¿‡ç©ºè¡Œ
            if [ -z "$name" ]; then
              continue
            fi
            
            # è·³è¿‡æ³¨é‡Šè¡Œ
            if [[ "$name" =~ ^[[:space:]]*# ]]; then
              continue
            fi
            
            # æ¸…ç†å¯èƒ½çš„ç©ºç™½å­—ç¬¦
            name=$(echo "$name" | xargs)
            
            total_count=$((total_count + 1))
            
            src="$SOURCE_DIR/$name.list"
            dst="shadowrocket/domain/$name.list"

            if [ ! -f "$src" ]; then
              echo "âš ï¸  Skip missing: $name.list"
              continue
            fi

            # å¤„ç†æ–‡ä»¶
            echo "ğŸ”„ Processing: $name"
            sed 's/^+\.//g' "$src" | sed 's/^/DOMAIN-SUFFIX,/' > "$dst"
            
            success_count=$((success_count + 1))
            echo "âœ… Generated: $dst (lines: $(wc -l < "$dst"))"
          done < "lists.txt"

          echo "=========================================="
          echo "Processing completed!"
          echo "Total entries processed: $total_count"
          echo "Successfully generated: $success_count"
          echo "=========================================="
          
          if [ $success_count -eq 0 ]; then
            echo "Error: No files were generated!"
            exit 1
          fi

      - name: List generated files
        run: |
          echo "ğŸ“ Generated files in shadowrocket/domain/:"
          if [ -d "shadowrocket/domain" ]; then
            ls -la shadowrocket/domain/*.list
            echo "Total files: $(ls shadowrocket/domain/*.list 2>/dev/null | wc -l)"
          else
            echo "Error: shadowrocket/domain directory not found!"
            exit 1
          fi

      - name: Commit and push changes
        run: |
          # è®¾ç½® Git ç”¨æˆ·ä¿¡æ¯
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          echo "ğŸ”„ Pulling latest changes from remote..."
          # æ‹‰å–è¿œç¨‹æ›´æ”¹å¹¶ rebase
          git pull origin main --rebase --autostash || {
            echo "Pull failed, trying alternative approach..."
            # å¦‚æœ rebase å¤±è´¥ï¼Œå°è¯•åˆå¹¶æ–¹å¼
            git fetch origin
            git merge origin/main || git merge --abort
          }
          
          echo "ğŸ“ Adding files to git..."
          # æ·»åŠ ç”Ÿæˆçš„æ–‡ä»¶
          git add shadowrocket/domain/*.list
          
          # æ£€æŸ¥æ˜¯å¦æœ‰ staged çš„æ›´æ”¹
          if git diff --cached --quiet; then
            echo "â„¹ï¸  No changes to commit"
            exit 0
          fi
          
          echo "ğŸ’¾ Creating commit..."
          # åˆ›å»ºæäº¤
          commit_message="Update selected geosite lists - $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          git commit -m "$commit_message"
          
          echo "ğŸš€ Pushing changes to remote..."
          # æ¨é€æ›´æ”¹
          max_retries=3
          retry_count=0
          
          while [ $retry_count -lt $max_retries ]; do
            if git push origin main; then
              echo "âœ… Successfully pushed changes!"
              break
            else
              retry_count=$((retry_count + 1))
              echo "âš ï¸  Push failed (attempt $retry_count/$max_retries)"
              
              if [ $retry_count -eq $max_retries ]; then
                echo "âŒ Failed to push after $max_retries attempts"
                exit 1
              fi
              
              echo "ğŸ”„ Pulling and retrying..."
              sleep 2
              git pull origin main --rebase
            fi
          done

      - name: Workflow completion
        run: |
          echo "ğŸ‰ Workflow completed successfully!"
          echo "Check the changes at: https://github.com/${{ github.repository }}/tree/main/shadowrocket/domain"
